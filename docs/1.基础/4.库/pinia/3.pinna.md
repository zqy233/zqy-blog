# pinia

> https://pinia.vuejs.org/zh/introduction.html
>
> piniaæ˜¯vueç”Ÿæ€é‡Œvuexçš„ä»£æ›¿è€…ï¼Œä¸€ä¸ªå…¨æ–°çŠ¶æ€ç®¡ç†åº“ï¼Œpiniaç›¸è¾ƒäºvuexçš„ä¼˜åŠ¿ï¼š
>
> 1. vue2å’Œvue3éƒ½å¯ä»¥å¾ˆå¥½çš„æ”¯æŒ
> 2. æŠ›å¼ƒäº†mutationsçš„æ“ä½œï¼Œåªæœ‰stateã€getterså’Œactionsï¼Œç®€åŒ–äº†çŠ¶æ€ç®¡ç†åº“çš„ä½¿ç”¨ï¼Œè®©ä»£ç ç¼–å†™æ›´åŠ å®¹æ˜“ç›´è§‚
> 3. ä¸éœ€è¦åµŒå¥—æ¨¡å—ï¼Œç¬¦åˆvue3çš„composition apiï¼Œè®©ä»£ç æ›´åŠ æ‰å¹³åŒ–
> 4. å®Œæ•´çš„TypeScriptæ”¯æŒ
> 5. ä»£ç æ›´åŠ ç®€æ´ï¼Œå¯ä»¥å®ç°å¾ˆå¥½çš„ä»£ç è‡ªåŠ¨åˆ†å‰²ã€‚vue2çš„æ—¶ä»£ï¼Œå†™ä»£ç éœ€è¦æ¥å›ç¿»æ»šå±å¹•å±å¹•æ‰¾å˜é‡ï¼ŒVue3çš„Composition apiå®Œç¾äº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ å¯ä»¥å®ç°ä»£ç åˆ†å‰²ï¼Œpiniaä¹ŸåŒæ ·ç»§æ‰¿äº†è¿™ä¸ªä¼˜ç‚¹
>
> å¯ä»¥ç®€å•æ€»ç»“piniaçš„ä¼˜åŠ¿å°±æ˜¯ï¼Œæ›´åŠ ç®€æ´çš„è¯­æ³•ï¼Œæ”¯æŒvue3çš„composition apiå’Œå¯¹typescriptçš„æ”¯æŒ

## å®‰è£…

```sh
pnpm add pinia
```

src/main.ts

```ts
import { createApp } from 'vue'
import App from './App.vue'
import { createPinia } from 'pinia' 

// åˆ›å»ºpiniaå®ä¾‹
const pinia = createPinia()

// æŒ‚è½½åˆ°Vueæ ¹å®ä¾‹ä¸Š
const app =createApp(App)
app.use(pinia).mount('#app')
```

Vue 2ï¼Œè¿˜éœ€è¦å®‰è£…æ’ä»¶

Vue 2 ä¸­ï¼ŒPinia ä½¿ç”¨çš„æ˜¯ Vuex çš„ç°æœ‰æ¥å£ (å› æ­¤ä¸èƒ½ä¸ Vuex ä¸€èµ·ä½¿ç”¨) 

```ts
import { createPinia, PiniaVuePlugin } from 'pinia'

Vue.use(PiniaVuePlugin)
const pinia = createPinia()

new Vue({
  el: '#app',
  // å…¶ä»–é…ç½®...
  // ...
  // è¯·æ³¨æ„ï¼ŒåŒä¸€ä¸ª`pinia'å®ä¾‹
  // å¯ä»¥åœ¨åŒä¸€ä¸ªé¡µé¢çš„å¤šä¸ª Vue åº”ç”¨ä¸­ä½¿ç”¨ã€‚ 
  pinia,
})
```

## Store æ˜¯ä»€ä¹ˆï¼Ÿ

Store (å¦‚ Pinia) æ˜¯ä¸€ä¸ªä¿å­˜çŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘çš„å®ä½“ï¼Œå®ƒå¹¶ä¸ä¸ä½ çš„ç»„ä»¶æ ‘ç»‘å®šã€‚æ¢å¥è¯è¯´ï¼Œ**å®ƒæ‰¿è½½ç€å…¨å±€çŠ¶æ€**ã€‚å®ƒæœ‰ç‚¹åƒä¸€ä¸ªæ°¸è¿œå­˜åœ¨çš„ç»„ä»¶ï¼Œæ¯ä¸ªç»„ä»¶éƒ½å¯ä»¥è¯»å–å’Œå†™å…¥å®ƒã€‚å®ƒæœ‰**ä¸‰ä¸ªæ¦‚å¿µ**ï¼Œstateã€getter å’Œ actionï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾è¿™äº›æ¦‚å¿µç›¸å½“äºç»„ä»¶ä¸­çš„ `data`ã€ `computed` å’Œ `methods`

## åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ Store

ä¸€ä¸ª Store åº”è¯¥åŒ…å«å¯ä»¥åœ¨æ•´ä¸ªåº”ç”¨ä¸­è®¿é—®çš„æ•°æ®ã€‚è¿™åŒ…æ‹¬åœ¨è®¸å¤šåœ°æ–¹ä½¿ç”¨çš„æ•°æ®ï¼Œä¾‹å¦‚æ˜¾ç¤ºåœ¨å¯¼èˆªæ ä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼Œä»¥åŠéœ€è¦é€šè¿‡é¡µé¢ä¿å­˜çš„æ•°æ®ï¼Œä¾‹å¦‚ä¸€ä¸ªéå¸¸å¤æ‚çš„å¤šæ­¥éª¤è¡¨å•

å¦ä¸€æ–¹é¢ï¼Œä½ åº”è¯¥é¿å…åœ¨ Store ä¸­å¼•å…¥é‚£äº›åŸæœ¬å¯ä»¥åœ¨ç»„ä»¶ä¸­ä¿å­˜çš„æœ¬åœ°æ•°æ®ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªå…ƒç´ åœ¨é¡µé¢ä¸­çš„å¯è§æ€§

å¹¶éæ‰€æœ‰çš„åº”ç”¨éƒ½éœ€è¦è®¿é—®å…¨å±€çŠ¶æ€ï¼Œä½†å¦‚æœä½ çš„åº”ç”¨ç¡®å®éœ€è¦ä¸€ä¸ªå…¨å±€çŠ¶æ€ï¼Œé‚£ Pinia å°†ä½¿ä½ çš„å¼€å‘è¿‡ç¨‹æ›´è½»æ¾

## å®šä¹‰store

 Store æ˜¯ç”¨ `defineStore()` æ–¹æ³•å®šä¹‰çš„ï¼Œéœ€è¦ä¸¤ä¸ªå‚æ•°

- å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°è¦æ±‚æ˜¯ä¸€ä¸ª**ç‹¬ä¸€æ— äºŒçš„**åå­—ï¼Œè¿™ä¸ª**åå­—** ï¼Œä¹Ÿè¢«ç”¨ä½œ *id* ï¼Œæ˜¯å¿…é¡»ä¼ å…¥çš„ï¼Œ Pinia å°†ç”¨å®ƒæ¥è¿æ¥ store å’Œ devtoolsã€‚ä¸ºäº†å…»æˆä¹ æƒ¯æ€§çš„ç”¨æ³•ï¼Œå°†è¿”å›çš„å‡½æ•°å‘½åä¸º *use...* æ˜¯ä¸€ä¸ªç¬¦åˆç»„åˆå¼å‡½æ•°é£æ ¼çš„çº¦å®š
- `defineStore()` çš„ç¬¬äºŒä¸ªå‚æ•°å¯æ¥å—ä¸¤ç±»å€¼ï¼šSetup å‡½æ•°æˆ– Option å¯¹è±¡

åˆ›å»º`src/store/index.ts`æ–‡ä»¶

```ts
import { defineStore } from 'pinia'

// ä½ å¯ä»¥å¯¹ `defineStore()` çš„è¿”å›å€¼è¿›è¡Œä»»æ„å‘½åï¼Œä½†æœ€å¥½ä½¿ç”¨ store çš„åå­—ï¼ŒåŒæ—¶ä»¥ `use` å¼€å¤´ä¸”ä»¥ `Store` ç»“å°¾ã€‚(æ¯”å¦‚ `useUserStore`ï¼Œ`useCartStore`ï¼Œ`useProductStore`)
// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä½ çš„åº”ç”¨ä¸­ Store çš„å”¯ä¸€ IDã€‚
export const useAlertsStore = defineStore('alerts', {
  // å…¶ä»–é…ç½®...
})
```

## Option Store

ä¸ Vue çš„é€‰é¡¹å¼ API ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªå¸¦æœ‰ `state`ã€`actions` ä¸ `getters` å±æ€§çš„ Option å¯¹è±¡

```ts
export const useCounterStore = defineStore('counter', {
  state: () => ({ count: 0 }),
  getters: {
    double: (state) => state.count * 2,
  },
  actions: {
    increment() {
      this.count++
    },
  },
})

```

ä½ å¯ä»¥è®¤ä¸º `state` æ˜¯ store çš„æ•°æ® (`data`)ï¼Œ`getters` æ˜¯ store çš„è®¡ç®—å±æ€§ (`computed`)ï¼Œè€Œ `actions` åˆ™æ˜¯æ–¹æ³• (`methods`)ã€‚

ä¸ºæ–¹ä¾¿ä¸Šæ‰‹ä½¿ç”¨ï¼ŒOption Store åº”å°½å¯èƒ½ç›´è§‚ç®€å•

## Setup Store

ä¹Ÿå­˜åœ¨å¦ä¸€ç§å®šä¹‰ store çš„å¯ç”¨è¯­æ³•ã€‚ä¸ Vue ç»„åˆå¼ API çš„ [setup å‡½æ•°](https://cn.vuejs.org/api/composition-api-setup.html) ç›¸ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å®šä¹‰äº†ä¸€äº›å“åº”å¼å±æ€§å’Œæ–¹æ³•ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå¸¦æœ‰æˆ‘ä»¬æƒ³æš´éœ²å‡ºå»çš„å±æ€§å’Œæ–¹æ³•çš„å¯¹è±¡

```js
export const useCounterStore = defineStore('counter', () => {
  const count = ref(0)
  function increment() {
    count.value++
  }

  return { count, increment }
})

```

åœ¨ *Setup Store* ä¸­ï¼š

- `ref()` å°±æ˜¯ `state` å±æ€§
- `computed()` å°±æ˜¯ `getters`
- `function()` å°±æ˜¯ `actions`

Setup store æ¯” Option Store å¸¦æ¥äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨ä¸€ä¸ª store å†…åˆ›å»ºä¾¦å¬å™¨ï¼Œå¹¶è‡ªç”±åœ°ä½¿ç”¨ä»»ä½•ç»„åˆå¼å‡½æ•°ã€‚ä¸è¿‡ï¼Œè¯·è®°ä½ï¼Œä½¿ç”¨ç»„åˆå¼å‡½æ•°ä¼šè®© SSR å˜å¾—æ›´åŠ å¤æ‚

## ä½¿ç”¨ Store

è™½ç„¶æˆ‘ä»¬å‰é¢å®šä¹‰äº†ä¸€ä¸ª storeï¼Œä½†åœ¨æˆ‘ä»¬ä½¿ç”¨ `<script setup>` è°ƒç”¨ `useStore()`(æˆ–è€…ä½¿ç”¨ `setup()` å‡½æ•°ï¼Œ**åƒæ‰€æœ‰çš„ç»„ä»¶é‚£æ ·**) ä¹‹å‰ï¼Œstore å®ä¾‹æ˜¯ä¸ä¼šè¢«åˆ›å»ºçš„ï¼š

```vue
<script setup>
import { useCounterStore } from '@/stores/counter'
// access the `store` variable anywhere in the component âœ¨
const store = useCounterStore()
</script>
```

ä½ å¯ä»¥å®šä¹‰ä»»æ„å¤šçš„ storeï¼Œä½†ä¸ºäº†è®©ä½¿ç”¨ pinia çš„ç›Šå¤„æœ€å¤§åŒ–(æ¯”å¦‚å…è®¸æ„å»ºå·¥å…·è‡ªåŠ¨è¿›è¡Œä»£ç åˆ†å‰²ä»¥åŠ TypeScript æ¨æ–­)ï¼Œ**ä½ åº”è¯¥åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­å»å®šä¹‰ store**

ä¸€æ—¦ store è¢«å®ä¾‹åŒ–ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—®åœ¨ store çš„ `state`ã€`getters` å’Œ `actions` ä¸­å®šä¹‰çš„ä»»ä½•å±æ€§

è¯·æ³¨æ„ï¼Œ`store` æ˜¯ä¸€ä¸ªç”¨ `reactive` åŒ…è£…çš„å¯¹è±¡ï¼Œè¿™æ„å‘³ç€ä¸éœ€è¦åœ¨ getters åé¢å†™ `.value`ï¼Œå°±åƒ `setup` ä¸­çš„ `props` ä¸€æ ·ï¼Œ**å¦‚æœå†™äº†ï¼Œä¹Ÿä¸èƒ½è§£æ„**ï¼š

```vue
<script setup>
const store = useCounterStore()
// âŒ This won't work because it breaks reactivity
// it's the same as destructuring from `props`
const { name, doubleCount } = store 
name // will always be "Eduardo" 
doubleCount // will always be 0 
setTimeout(() => {
  store.increment()
}, 1000)
// âœ… this one will be reactive
// ğŸ’¡ but you could also just use `store.doubleCount` directly
const doubleValue = computed(() => store.doubleCount)
</script>
```

ä¸ºäº†ä» store ä¸­æå–å±æ€§æ—¶ä¿æŒå…¶å“åº”æ€§ï¼Œä½ éœ€è¦ä½¿ç”¨ `storeToRefs()`ã€‚å®ƒå°†ä¸ºæ¯ä¸€ä¸ªå“åº”å¼å±æ€§åˆ›å»ºå¼•ç”¨ã€‚å½“ä½ åªä½¿ç”¨ store çš„çŠ¶æ€è€Œä¸è°ƒç”¨ä»»ä½• action æ—¶ï¼Œå®ƒä¼šéå¸¸æœ‰ç”¨ã€‚è¯·æ³¨æ„ï¼Œä½ å¯ä»¥ç›´æ¥ä» store ä¸­è§£æ„ actionï¼Œå› ä¸ºå®ƒä»¬ä¹Ÿè¢«ç»‘å®šåˆ° store ä¸Šï¼š

```vue
<script setup>
import { storeToRefs } from 'pinia'
const store = useCounterStore()
// `name` and `doubleCount` are reactive refs
// This will also extract refs for properties added by plugins
// but skip any action or non reactive (non ref/reactive) property
const { name, doubleCount } = storeToRefs(store)
// the increment action can just be destructured
const { increment } = store
</script>
```

## TypeScriptæ”¯æŒ

å¹¶ä¸éœ€è¦åšå¤ªå¤šåŠªåŠ›å°±èƒ½ä½¿ state å…¼å®¹ TSã€‚ Pinia ä¼šè‡ªåŠ¨æ¨æ–­å‡º state çš„ç±»å‹ï¼Œä½†åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œå¾—ç”¨ä¸€äº›æ–¹æ³•æ¥å¸®å®ƒä¸€æŠŠ

```ts
const useStore = defineStore('storeId', {
  state: () => {
    return {
      // ç”¨äºåˆå§‹åŒ–ç©ºåˆ—è¡¨
      userList: [] as UserInfo[],
      // ç”¨äºå°šæœªåŠ è½½çš„æ•°æ®
      user: null as UserInfo | null,
    }
  },
})

interface UserInfo {
  name: string
  age: number
}
```

æˆ–è€…ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæ¥å£å®šä¹‰ stateï¼Œå¹¶æ·»åŠ  `state()` çš„è¿”å›å€¼çš„ç±»å‹

```ts
interface State {
  userList: UserInfo[]
  user: UserInfo | null
}

const useStore = defineStore('storeId', {
  state: (): State => {
    return {
      userList: [],
      user: null,
    }
  },
})

interface UserInfo {
  name: string
  age: number
}
```

## è®¿é—® state 

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ `store` å®ä¾‹è®¿é—® stateï¼Œç›´æ¥å¯¹å…¶è¿›è¡Œè¯»å†™

```vue
<template>
  <h2>{{ store.count }}</h2>
  <button @click="add">å¢åŠ </button>
</template>

<script lang="ts" setup>
import { useCounterStore } from '@/stores/index'
const store = useCounterStore()
const add = () => {
  store.count++
}
</script>
```

## è§£æ„èµ‹å€¼ `storeToRefs()`

ä¸ºäº†ä» store ä¸­æå–å±æ€§æ—¶ä¿æŒå…¶å“åº”æ€§ï¼Œéœ€è¦ä½¿ç”¨ `storeToRefs()`ã€‚å®ƒå°†ä¸ºæ¯ä¸€ä¸ªå“åº”å¼å±æ€§åˆ›å»ºå¼•ç”¨

```vue
<template>
  <h2>{{ store.count }}</h2>
  <button @click="add">å¢åŠ </button>
</template>

<script lang="ts" setup>
import { storeToRefs } from 'pinia'
import { useCounterStore } from '@/stores/index'
const store = useCounterStore()
let { count } = storeToRefs(store)
const add = () => {
  count.value++
}
const reset = () => {
  store.$reset()
}
</script>
```

## é‡ç½® state

```ts
<template>
  <h2>{{ count }}</h2>
  <button @click="add">å¢åŠ </button>
  <button @click="reset">é‡ç½®</button>
</template>

<script lang="ts" setup>
import { storeToRefs } from 'pinia'
import { useCounterStore } from '@/stores/index'
const store = useCounterStore()
let { count } = storeToRefs(store)
const add = () => {
  count.value++
}
const reset = () => {
  store.$reset()
}
</script>
```

## ä¿®æ”¹æ•°æ®

storeæ•°æ®å¢åŠ ä¸€ä¸ªcountï¼Œ\src\store\index.tsæ–‡ä»¶å¦‚ä¸‹

```ts
state:()=>{
  return {
    count:0
  }
},
```

æ–°å»ºä¸¤ä¸ªç»„ä»¶ï¼Œåœ¨ä¸€ä¸ªç»„ä»¶é‡Œä¿®æ”¹çŠ¶æ€æ•°æ®ï¼Œè§‚å¯Ÿå¦ä¸€ä¸ªç»„ä»¶ä¸­çš„æ•°æ®æ˜¯å¦ä¼šæ”¹å˜

åœ¨\components\æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªç»„ä»¶

```vue
<template>
  <h2 class="">{{ store.count }}</h2>
</template>

<script lang="ts" setup>
import { mainStore } from "@/store/index";
const store = mainStore();
</script>
```

åœ¨components\æ–‡ä»¶å¤¹ä¸‹æ–°å»ºå¦ä¸€ä¸ªç»„ä»¶

```vue
<template>
  <button @click="handleClick">ç‚¹å‡»å¢åŠ </button>
</template>

<script lang="ts" setup>
import { mainStore } from "@/store/index";
const store = mainStore()

const handleClick = () => {
  store.count++
};
</script>

<style lang="scss" scoped></style>
```

app.vueä¸­ä½¿ç”¨è¿™ä¸¤ä¸ªç»„ä»¶

```jsx
<template>
  <storeData></storeData>
  <addButton></addButton>
</template>
```

> è§£æ„èµ‹å€¼çš„å‘

è¿™æ ·è§£æ„æ˜¯æ²¡æœ‰ä½œç”¨çš„

```jsx
<template>
  <h2 class="">{{ store.count }}</h2>
  <hr />
  <h2 class="">{{ count }}</h2>
</template>

<script lang="ts" setup>
import { mainStore } from "../store/index"
const store = mainStore()
const { count } = store
</script>
```

æ­£ç¡®çš„è§£æ„æ–¹å¼

```jsx
<template>
  <h2>{{ count }}</h2>
</template>

<script lang="ts" setup>
import { mainStore } from "../store/index"
import { storeToRefs } from "pinia"
const { count } = storeToRefs(mainStore())
</script>
```

## ä¿®æ”¹æ•°æ®çš„å¦å¤–ä¸‰ç§æ–¹å¼

ä¿®æ”¹å¤šæ¡æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨`$patch`çš„æ–¹æ³•ï¼Œpiniaçš„å®˜æ–¹æ–‡æ¡£æ˜ç¡®è¡¨ç¤º$patchçš„æ–¹å¼æ˜¯ç»è¿‡ä¼˜åŒ–çš„ï¼Œä¼šåŠ å¿«ä¿®æ”¹é€Ÿåº¦ï¼Œå¯¹ç¨‹åºçš„æ€§èƒ½æœ‰å¾ˆå¤§çš„å¥½å¤„

ä¸€ï¼Œä½¿ç”¨å¯¹è±¡çš„å†™æ³•

```js
const handleClickPatch = () => {
  store.$patch({
    count: store.count + 2,
    state.helloWorld = state.helloWorld === "hello" ? "world" : "hello"
  })
}
```

äºŒï¼Œä½¿ç”¨å‡½æ•°çš„å†™æ³•

```js
const handleClickMethod = () => {
  store.$patch((state) => {
    state.count++
    state.helloWorld = state.helloWorld === "hello" ? "world" : "hello";
  })
}
```

ä¸‰ï¼Œä½¿ç”¨actions

```typescript
actions:{
    changeState(){
        this.count++
        this.helloWorld='hello'
    }
  }
```

```js
const handleClickActions = ()=>{
  store.changeState()
}
```

## getters

å’Œvueä¸­çš„è®¡ç®—å±æ€§å‡ ä¹ä¸€æ ·ï¼Œå°±æ˜¯åœ¨è·å–stateçš„å€¼æ—¶ä½œä¸€äº›å¤„ç†ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œgetterså…·æœ‰ç¼“å­˜ç‰¹æ€§

```js
getters:{
    phoneHidden(state){
      return state.phone.toString().replace(/^(\d{3})\d{4}(\d{4})$/, '$1****$2')
    }
  }
```

## å¤šä¸ªstore

```typescript
import { defineStore } from "pinia"

const otherStore = defineStore("other", {
  state: () => {
    return {
      count: 0
    }
  }
})

export const mainStore = defineStore("main", {
  state: () => {
    return {
      hello: "world"
    }
  },
  getters: {
    doubleCount: () => otherStore().count * 2
  },
  actions: {
    add() {
      otherStore().count++
    }
  }
})
```

## vue-devtoolsè°ƒè¯•pinna

å®‰è£…vue-devtoolsæ’ä»¶ï¼Œf12è°ƒè¯•é¡¹ç›®ï¼Œå¯ä»¥æŸ¥çœ‹piniaæ•°æ®

